# Deploy Crosswit to Hetzner: git pull, build, restart on server (same as manual deploy).
# Required secrets: SERVER_HOST, SERVER_USER, SSH_PRIVATE_KEY
# Required for DB/auth: DATABASE_URL (PostgreSQL URL), AUTH_SECRET, AUTH_URL; or DEPLOY_ENV_FILE=true + ENV_FILE variable (base64 .env)
# Optional secret: PORT (default 5000 for next start)
# Server needs: Node 20+, npm, PM2 (npm i -g pm2), git repo cloned at /home/hrvoje/apps/crosswit
name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SERVER_HOST }}
      SSH_USER: ${{ secrets.SERVER_USER }}
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create .env on server
        run: |
          if [ "${{ vars.DEPLOY_ENV_FILE }}" = "true" ] && [ -n "${{ vars.ENV_FILE }}" ]; then
            echo "${{ vars.ENV_FILE }}" | base64 -d | ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new $SSH_USER@$SSH_HOST "mkdir -p /home/hrvoje/apps/crosswit && cat > /home/hrvoje/apps/crosswit/.env"
          elif [ -n "${{ secrets.DATABASE_URL }}" ]; then
            printf 'DATABASE_URL=%s\nAUTH_SECRET=%s\nAUTH_URL=%s\nPORT=%s\n' \
              "${{ secrets.DATABASE_URL }}" \
              "${{ secrets.AUTH_SECRET }}" \
              "${{ secrets.AUTH_URL }}" \
              "${{ secrets.PORT }}" > /tmp/deploy.env
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new $SSH_USER@$SSH_HOST "mkdir -p /home/hrvoje/apps/crosswit"
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new /tmp/deploy.env $SSH_USER@$SSH_HOST:/home/hrvoje/apps/crosswit/.env
            rm -f /tmp/deploy.env
          else
            echo "::error::Add DATABASE_URL secret (and AUTH_SECRET, AUTH_URL), or DEPLOY_ENV_FILE=true + ENV_FILE variable"
            exit 1
          fi

      - name: Pull, install, build, restart
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new $SSH_USER@$SSH_HOST "cd /home/hrvoje/apps/crosswit && git pull && npm ci && npx prisma generate && (npx prisma migrate deploy 2>/dev/null || true) && npm run build && (pm2 restart crosswit || pm2 start npm --name crosswit -- run start) && pm2 save"
